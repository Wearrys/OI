% 计算几何相关
% Wearry
% Jan 10，2020

---

# Table of Contents

- 基础知识
    - 叉积与点积
    - 点, 直线与圆的位置关系
    - 凸包与半平面交
- 进阶技巧与算法
    - 扫描线
    - 辛普森积分
    - 平面图与点定位
    - 最小圆覆盖
- 题目选讲

---

# 叉积

## 定义

对于所有 $\mathbf{u}, \mathbf{v} \in \mathbb{R}^3$， 定义：

$$\mathbf{u} \times \mathbf{v} = (|\mathbf{u}||\mathbf{v}|\sin{\theta}) \mathbf{n}$$

其中 $\theta$ 为 $\mathbf{u}, \mathbf{v}$ 之间的夹角， 
$\mathbf{n}$ 为垂直于 $\mathbf{u}, \mathbf{v}$ 所在平面的单位向量。

. . .

## 计算

对于 $\mathbb{R}^3$ 上的基向量 $\mathbf{i, j, k}$ 不难得到：

$$ \begin{aligned} 
\mathbf{i} \times \mathbf{j} = \mathbf{k} \quad \mathbf{j} \times \mathbf{i} = \mathbf{-k} \\
\mathbf{j} \times \mathbf{k} = \mathbf{i} \quad \mathbf{k} \times \mathbf{j} = \mathbf{-i} \\
\mathbf{k} \times \mathbf{i} = \mathbf{j} \quad \mathbf{i} \times \mathbf{k} = \mathbf{-j}
\end{aligned} $$

---

# 叉积

## 计算

对于 $\mathbb{R}^3$ 上的基向量 $\mathbf{i, j, k}$ 不难得到：

$$ \begin{aligned} 
\mathbf{i} \times \mathbf{j} = \mathbf{k} \quad \mathbf{j} \times \mathbf{i} = \mathbf{-k} \\
\mathbf{j} \times \mathbf{k} = \mathbf{i} \quad \mathbf{k} \times \mathbf{j} = \mathbf{-i} \\
\mathbf{k} \times \mathbf{i} = \mathbf{j} \quad \mathbf{i} \times \mathbf{k} = \mathbf{-j}
\end{aligned} $$

所以：

$$ \begin{aligned}
& \mathbf{u} \times \mathbf{v} \\
= & (a \mathbf{i} + b \mathbf{j} + c \mathbf{k}) \times (d \mathbf{i} + e \mathbf{j} + f \mathbf{k}) \\
= & ((bf - ce) \mathbf{i} + (cd - af) \mathbf{j} + (ae - bd) \mathbf{k})
\end{aligned} $$

---

# 叉积

## 性质

- 本质上 $\mathbb{R}^3$ 上的两向量叉积得到的是一个垂直于两向量所在平面的新向量， 方向遵循右手定则。
\pause

- 叉积计算得到的向量长度恰好是两个向量形成的平行四边形面积。
\pause

- 可以将 $\mathbb{R}^2$ 上的向量视为 $\mathbb{R}^3$ 上的 $z=0$ 的特殊向量，
并利用 $ae - bd$ 求出两向量形成的平行四边形的有向面积。
\pause

- 与给定向量做叉积本质上是一个线性变换，推广到二维情形也成立。

---

# 点积

## 定义

对于任意两个向量 $\mathbf{u}, \mathbf{v}$， 定义：

$$\mathbf{u} \cdot \mathbf{v} = |\mathbf{u}||\mathbf{v}|\cos{\theta}$$

. . .

## 性质

- 几何意义是 $\mathbf{u}$ 在 $\mathbf{v}$ 上的投影长度乘以 $|\mathbf{v}|$。
- 与叉积不同，运算的结果是一个常量，并且交换顺序不会影响结果。
- 与给定向量做点积也是线性变换，可以利用与叉积类似的方法推导出任意向量之间的点积计算公式，并且可以推广到任意维度。

---

# 思考题

给出三个 $\mathbb{R}^3$ 上的线性无关的向量 $\mathbf{a, b, c}$，
求这三个向量构成的平行六面体的体积。

\begin{figure}[h]
    \includegraphics[width=4.5cm]{p1.png}
\end{figure}

. . .

根据叉积和点积的定义，不难得到：

$$V = \mathbf{a} \cdot (\mathbf{b} \times \mathbf{c})$$

---

# 点，直线与圆的位置关系

## 两线段 $AB, CD$

- 规范相交：两线段的交点严格在线段内部（与线段端点不相交）

$$ \begin{aligned}
(\overrightarrow{CB} \times \overrightarrow{CD})
(\overrightarrow{CA} \times \overrightarrow{CD}) < 0 \\
(\overrightarrow{AD} \times \overrightarrow{AB})
(\overrightarrow{AC} \times \overrightarrow{AB}) < 0
\end{aligned} $$

- 非规范相交：两线段交点在端点上，在规范相交的基础上判断某条线段的端点是否在另一线段上即可。

---

# 点，直线与圆的位置关系

## 点 $P$ 与直线 $AB$

- 距离:

$$\mathrm{dist}(P, AB) = \frac{|\overrightarrow{AB} \times \overrightarrow{AP}|}{|AB|}$$

. . .

- 投影点：

$$\mathrm{proj}(P, AB) = A + \left(\frac{\overrightarrow{AB} \cdot \overrightarrow{AP}}{|AB|^2}\right) \overrightarrow{AB}$$

---

# 点，直线与圆的位置关系

## 直线 $AB$ 与圆 $(O, r)$

- 位置关系：利用圆心到直线的距离直接判断。

- 求交点：
    - 求出圆心到直线的距离 $\mathrm{dist}(O, AB)$ 与投影点 $\mathrm{proj}(O, AB)$。
    - 利用勾股定理求出弦长并得到圆心角, 旋转 $\overrightarrow{OP}$ 并将长度缩放为 $r$。
    - 将 $O$ 沿着得到的向量移动就能找到交点。

---

# 点，直线与圆的位置关系

## 圆 $(O1, r1)$ 与圆 $(O2, r2)$ 之间

- 位置关系：直接利用距离判断。
- 求交点：
    - 求圆心之间的距离，并利用余弦定理求出圆心角。
    - 旋转 $\overrightarrow{O1O2}$ 并缩放使其等于 $r1$，将 $O1$ 沿此向量移动后得到交点。
- 求公切线：如下图，先求出旋转角度，然后移动向量即可。

\begin{figure}[h]
    \includegraphics[width=4.2cm]{p2.png}
    \includegraphics[width=4.2cm]{p3.png}
\end{figure}

---

# 凸包

一个点集的凸包就是能够包含点集内部所有点的最小凸多边形。

## 旋转卡壳

- 对踵点对：用平行线夹住一个凸多边形时落在不同平行线上的点对。
- 最远点对：
    - 一定在对踵点对中产生。
    - 凸包上点到一条边的距离是单峰的，用双指针可以做到线性复杂度。

. . .

## Minkowski Sum

- 定义： 对点集$A, B$，定义新点集 $A + B = \{x + y \mid x \in A, y \in B\}$。

- 求 $A + B$ 的凸包：
只需要考虑点集 $A, B$ 中凸包上的点即可，
从 $a_1 + b_1$ 开始拓展，每次选择更靠外的向量作为凸包边界即可。

---

# 半平面交

\qquad 半平面指平面上一条直线一侧的所有部分，可以用有序点对 $(P, Q)$ 描述 $\overrightarrow{PQ}$ 左侧的半平面。
半平面的交一定是凸的，求解时维护一个双端队列，按照斜率顺序加入半平面，并处理队列首尾的弹出情况。

. . .

\vspace {2ex}

## 应用

- 求多边形的内核。
\pause

- 求若干个凸多边形的交集。
\pause

- 判定线性规划类型问题的解的存在性。

---

# 思考题

\qquad 给定三个凸多边形 $A, B, C$ ，从三个凸多边形内部分别选出一个点并求构成图形的重心，
多次询问一个点是否是可能的重心。

\vspace{2ex}

$|A|, |B|, |C| \le 10^5$

---

# 思考题

\qquad 首先我们知道，三个点 $X, Y, Z$ 的重心为 $\frac{X + Y + Z}{3}$，那么相当于求 $X+Y+Z$ 的可能的点集。
\pause

\qquad 可以证明，任意两个凸多边形内部的所有点构成的集合求 \textrm{Minkowski Sum} 得到的点集也是一个凸多边形。
于是 $X+Y+Z$ 一定在 $A, B, C$ 三个凸多边形的闵科夫斯基和所在的凸包内部。
\pause

\qquad 判断点是否在多边形内部可以使用射线法，判断从这个点出发向右的水平射线与多边形的交点个数。

---

# 扫描线

\qquad 扫描线是计算几何中的常用算法。

\qquad 核心思路是利用某种方式将平面分割成若干个部分，
每个部分内部图形之间的位置关系不会发生大的变化，
然后对每部分分开计算答案。

\qquad 常见的分割方式有水平/垂直坐标顺序和极角顺序。

---

# 辛普森积分

\qquad 对于连续变化的函数，可以使用积分法求出函数下方图形的面积。
对一些不好计算积分的函数，可以考虑近似计算。

\qquad 用二次函数的曲线来拟合待求积分的函数，将待求函数划分成若干个较小的段，
每段分别拟合最后相加得到答案。

\pause
\vspace{2ex}

\qquad 对于区间 $[l, r]$，使用 $S(l, r) = \frac{(f(l) + 4f(m) + f(r)) * (r - l)}{6}$ 计算近似的积分。同时可以根据精度要求进行自适应，
即如果 $S(l, m) + S(m, r)$ 与 $S(l, r)$ 的值相差不超过精度误差的话就终止递归。

\qquad 对于多元函数，如果在各个方向上都连续，则可以嵌套使用辛普森积分求高维体积。

---

# 最小圆覆盖

\qquad 对于给定的点集，求一个面积最小的圆使得所有点集中的点都在圆内。
\pause

\qquad 这是一个经典问题，可以使用随机增量法求解：

- 将点集随机打乱，并依次加入，如果第 $i$ 个点不在前 $i-1$ 个点的最小圆内，说明它在前 $i$ 个点的最小覆盖圆上，则转化为下面的子问题。

- 已知点 $i$ 在前 $i$ 个点的最小覆盖圆上，依次加入前 $i-1$ 个点，如果点 $j$ 不在前 $j-1$ 个点和点 $i$ 的最小覆盖圆上，
说明这个点也在最小覆盖圆上，再次转化成如下问题。

- 已知点 $i, j$ 在前 $i$ 个点的最小覆盖圆上，依次加入前 $j-1$ 个点，如果点 $k$ 不在前 $k-1$ 个点和点 $i, j$ 的最小覆盖圆上，
说明最小覆盖圆上的点是 $i, j, k$。

---

# 最小圆覆盖

## 复杂度分析

1. 最内层的复杂度显然是 $O(n)$ 的。

2. 第二层在 $j$ 有 $\frac{2}{j}$ 的概率递归并产生 $O(j)$ 的贡献，所以复杂度也是 $O(n)$ 的。

3. 第一层与第二层同理，在点 $i$ 有 $\frac{3}{i}$ 的概率递归，所以复杂度也是 $O(n)$ 的。

---

# 平面图

## 对偶图

- 把每条无向边拆成两条有向边，并把每个点的出边按极角排序。

- 从任意一条未访问的有向边出发，
在当前边终点处选择该边反向边的顺时针方向下一条边接着走。走回起点时就找到了一个新的区域。

- 不断重复上面的过程直到走过了所有的边。

- 无界的区域可能需要特殊处理，可以用叉积算有向面积来判断，如果不是正的就说明是无界的。

- 同一条边的两条有向边左侧的区域之间在对偶图上有一条边相连。

. . .

## 点定位

\qquad 在求出对偶图后，将原图中的每条边取出来和询问点一起做一遍扫描线即可。

---

# 清华集训2012 阳光

\qquad 给出一个简单 $n$ 边形和一个以原点为圆心的半径为 $r$ 的圆，
求一种 $m$ 等分圆的方案，使得尽可能多的等分点落在多边形内部。

\vspace{2ex}

$n, m \le 10^5, r \le 10$

---

# 清华集训2012 阳光

\qquad 按顺序求出多边形和圆的每个交点，这些交点将圆分成若干段，每一段圆弧上的点和多边形的位置关系是一致的。

\pause
\vspace{2ex}

\qquad 若第一个点的弧度为 $a \mid a \le \frac{2\pi}{m}$ ，则第 $i$ 个等分点的弧度为 $\frac{2\pi(i-1)}{m} + a$ ，
将圆上 $\left[\frac{2\pi i}{m}, \frac{2\pi(i+1)}{m}\right]$ 的弧映射到 $[0, \frac{2\pi}{m}]$ 这段弧上，
则确定了 $a$ 以后，多边形内部的等分点的数量等于 $a$ 被在多边形内部的圆弧覆盖的次数。

\qquad 在投影完后的 $\frac{1}{m}$ 圆上再做一次扫描线求出被覆盖次数的最大值即可。

---

# PKUSC2018 PKUSC

\qquad 给定平面上的 $n$ 个点和一个 $m$ 边形，绕原点随机旋转这个 $m$ 边形，求这个图形围住的点的数量的期望值。

\vspace{2ex}

$n \le 200, m \le 500$

---

# PKUSC2018 PKUSC

\qquad 首先将多边形的旋转视为点旋转，并考虑每个点对答案的贡献。
\pause

\qquad 每个点旋转后的轨迹是一个圆，这个点对答案产生的贡献是在多边形内部的圆弧长度占圆的周长的比例。
\pause

\qquad 可以求出圆和多边形的交点并依据这些交点将圆弧分成若干段，问题转化成判断某段弧是否在多边形内部。
\pause

\qquad 为避免讨论特殊边界情况，可以求出每段弧的中点并判断中点是否在多边形内部。

---

# 清华集训2012 保护古迹

\qquad 平面上有 $n$ 个点需要被保护，有 $m$ 个篱笆桩和 $q$ 种修建篱笆的方案，
每种方案形如 $(u, v, w)$ 表示在第 $u$ 个篱笆桩和第 $v$ 个篱笆桩之间修建篱笆，花费为 $w$，
修建篱笆的方案保证不相交。

\qquad 对于 $k \in [1, n]$，求使用篱笆围住至少 $k$ 个需要保护的点的最小花费。

\vspace{2ex}

$n \le 10, m \le 100, q \le \frac{m(m-1)}{2}$

---

# 清华集训2012 保护古迹

\qquad 修建篱笆的方案和篱笆桩构成了一个平面图，先利用点定位确定每个需要被保护的点所在的平面图区域。

. . .

\qquad 用篱笆将一个点围住等价于在平面图上这个点与无界区域之间不联通，可以使用最小割来求解。

. . .

\qquad 对于至少围住 $k$ 个点的方案可以枚举需要保护的点的子集并更新答案。

---

# 51nod1784 小Z教化学

\qquad 有一些包含两种溶质的溶剂，能够以任意比例混合，
$x$ 体积的浓度分别为 $(a, b)$ 和 $y$ 体积的浓度为 $(c, d)$ 的溶剂混合后得到的溶剂浓度分别为 $(\frac{ax+cy}{x+y}, \frac{bx+dy}{x+y})$ 。

\qquad 现在有 $n$ 组溶剂，第 $i$ 组有 $s_i$ 种初始浓度确定并且数量无限的溶剂，
现在你想知道对于任意三个不同的组，是否都存在一种溶剂使得这三个组能各自使用组内的溶剂配置出来。

\vspace{2ex}

$n, \sum{s_i} \le 200000$

---

# 51nod1784 小Z教化学

\qquad 用平面上的点 $(x, y)$ 表示浓度分别为 $(x, y)$ 的一种溶剂，不难发现，
一组溶剂能够配置出的所有溶剂的点集是这组溶剂中的点构成的凸包，相当于询问任意三个凸包是否恒有交点。
\pause

\begin{block}{Helly's Theorem}
平面上若干个凸集中任意三个有交等价于所有凸集有交。
\end{block}

\qquad 先求出每一组内的溶剂构成的凸包，接下来只需要使用半平面交判定所有凸包的交是否为空即可，需要注意处理凸包退化的情况。

---

# Sasha Circle  

\qquad 平面上有两个点集 $A,B$，问是否存在一个圆能够包含所有其中一个集合内的点并且严格不包含所有另一个集合的点。

\vspace{2ex}

$|A|, |B|, |x_i|, |y_i| \le 10000$

---

# Sasha Circle

\qquad 假定圆内包含的点集是 $A$，否则同理。

\qquad 不难发现圆上一定至少包含两个集合 $A$ 中的点，得到一个暴力算法：
枚举 $A$ 中在圆上的两点，圆心所在直线就确定了下来，依次考虑其它所有的点得到圆心的合法范围，判断其交集是否为空即可。
\pause

\qquad 一个比较显然的优化是，只需要考虑 $A$ 集合中凸包上的点对并进行判断即可。

---

# Sasha Circle

\qquad 接下来的部分需要一些转换，将原平面作为平面 $z = 0$ ，
考虑三维坐标系中的抛物面 $z = x^2 + y^2$ 一个不与 $z = 0$ 垂直的截面在 $z=0$ 上的投影。
\pause

\qquad 假设平面为 $ax + by + z = c$ ，那么：

$$ \begin{aligned}
x^2 + ax + y^2 + by &= c \\
(x + \frac{a}{2})^2 + (y + \frac{b}{2})^2 &= c + \frac{a^2+b^2}{4} 
\end{aligned} $$

\pause

\qquad 可以看出投影是一个圆，将点对应到抛物面上，
可以发现圆内的点一定在对应平面下方，圆外的点一定在对应平面上方，圆上的点一定在对应平面上。

---

# Sasha Circle

\qquad 问题转化为求一个平面，将抛物面上两点集分开。
类比于平面上的情况，可知如果有解，则一定存在一个平面经过下方点集的上凸壳上两个相邻的点。
\pause

\qquad 考虑上凸壳的边在 $z = 0$ 上的正投影，发现投影会是平面上对应凸包的一个剖分，如下图：

\begin{figure}[h]
    \includegraphics[width=3cm]{p4.png}
\end{figure}

\qquad 对于凸壳的每一个面，凸壳必然在其所在平面下面，对应到平面上就是凸包必然在三角剖分后每个三角形的外接圆内部。 

---

# Sasha Circle

\qquad 只需要找到一个这样的剖分，需要枚举的边数就降到凸包的点数级别了，关于凸包上的点数规模有一个结论：

\begin{block}{引理}
整点构成的凸包点数不超过 $O(S ^ \frac{2}{3})$，其中 $S$ 表示凸包上点的坐标范围。
\end{block}

\pause

\qquad 考虑如何求这样的剖分，可以使用分治，用 $solve(l, r)$ 表示将点 $l$ 到点 $r$ 之间的凸壳剖分。

\qquad 将 $(l, r)$ 这条边作为底边，找到一个点 $k \mid l < k < r$ ，
使得这点 $l, k, r$ 构成三角形的外接圆最大，可以证明这个外接圆会包含整个凸包，然后递归处理两边即可。

---

# Donuts

\qquad 求空间中 $n$ 个“甜甜圈”体的体积并，
每一个“甜甜圈”体是一个 $x-z$ 平面上的圆围绕一条平行于 $z$ 轴的直线旋转得到的旋转体，如下图：

\vspace{2ex}

$n \le 20$

\pause

\begin{figure}[h]
    \includegraphics[height=4cm]{p5.png}
\end{figure}

---

# Donuts

\qquad 首先考虑二维情况，求若干个环的面积并。

\qquad 直接套用辛普森积分计算即可，对于每一个 $x$ , 
求出每个环与这条直线的交，然后对所有的环求并计算总长度即可。

\pause

\qquad 三维的情况也是类似的，考虑在外层嵌套一次辛普森积分，
令 $f(t)$ 表示“甜甜圈”体的 $z = t$ 截面面积，对 $f$ 函数求积分即可。

\qquad 需要注意图形之间的空隙可能会影响答案，需要分成若干段分别求积分。

---

# 可见区域

\qquad 在平面直角坐标系中有 $n$ 条互不相交且所在直线不会经过 $(0, 0)$ 的线段。
有一个人站在$(0, 0)$，他在某一个方向上的视野会被该方向上碰到的第一条线段阻挡。

\qquad 他想知道，在删除 ${0, 1, 2}$ 条线段的情况下最多能看到多大的面积。

\vspace{2ex} 

$n \le 50000$

---

# 可见区域

\qquad 线段可以视为极角上的一段区间，考虑扫描线。
称线段 $A$ 优于线段 $B$，当且仅当存在某个角度使得从原点出发的视野先经过线段 $A$，然后经过线段 $B$。

\qquad 由于线段之间没有相交关系，所以优于关系一定是单向的，
在某个特定的角度上的优于关系构成全序集，因此可以使用平衡树维护。

\qquad 在每一段中阻挡视野的是同一条线段，因此面积可以分割成若干个三角形的面积和。

---

# 可见区域

\qquad 考虑删除一条线段后的答案，只会影响到这条线段阻挡视野的区间，
对于每一段分别计算贡献，找到最优的一条线段即可。

\qquad 考虑删除两条线段的答案，有两种可能的情况：

1. 删去前一种情况中贡献最大的两条线段。

2. 若存在某个区间满足这两条线段分别是视线碰到的第一条和第二条线段，则还会产生额外的贡献。
显然这样的线段对至多只有 $O(n)$ 种，所以复杂度是正确的。

